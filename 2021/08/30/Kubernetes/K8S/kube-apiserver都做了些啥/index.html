<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"owl0214.github.io","root":"/","images":"/images","scheme":"Mist","version":"8.7.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="apiserver启动时，主要步骤为注册资源-&gt;Cobra解析配置-&gt;创建ServerChain-&gt;准备启动-&gt;启动">
<meta property="og:type" content="article">
<meta property="og:title" content="apiserver启动分析">
<meta property="og:url" content="https://owl0214.github.io/2021/08/30/Kubernetes/K8S/kube-apiserver%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E5%95%A5/index.html">
<meta property="og:site_name" content="琦闻E事">
<meta property="og:description" content="apiserver启动时，主要步骤为注册资源-&gt;Cobra解析配置-&gt;创建ServerChain-&gt;准备启动-&gt;启动">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-08-30T06:11:19.000Z">
<meta property="article:author" content="大力运天地">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://owl0214.github.io/2021/08/30/Kubernetes/K8S/kube-apiserver%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E5%95%A5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://owl0214.github.io/2021/08/30/Kubernetes/K8S/kube-apiserver%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E5%95%A5/","path":"2021/08/30/Kubernetes/K8S/kube-apiserver都做了些啥/","title":"apiserver启动分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>apiserver启动分析 | 琦闻E事</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999;right:unset;left:32px;top:15px;bottom:unset}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">琦闻E事</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#kube-apiserver"><span class="nav-number">1.</span> <span class="nav-text">kube-apiserver</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kube-apiserver%E6%9E%B6%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">kube-apiserver架构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#apiserver%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">apiserver启动流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8Ck8s%E6%89%80%E6%94%AF%E6%8C%81%E7%9A%84%E8%B5%84%E6%BA%90"><span class="nav-number">2.1.</span> <span class="nav-text">注册k8s所支持的资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cobra%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">Cobra命令行解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAServerChain"><span class="nav-number">2.3.</span> <span class="nav-text">创建ServerChain</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.1.</span> <span class="nav-text">创建通用配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAAPIExtensionsServer"><span class="nav-number">2.3.2.</span> <span class="nav-text">创建APIExtensionsServer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%A6%82%E8%BF%B0"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">逻辑概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAGenericServer"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">创建GenericServer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#InstallAPI"><span class="nav-number">2.3.2.2.1.</span> <span class="nav-text">InstallAPI</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InstallAPIGroups%E7%9A%84%E4%B8%BB%E8%A6%81%E5%A4%84%E7%90%86"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">InstallAPIGroups的主要处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#installAPIResources"><span class="nav-number">2.3.2.3.1.</span> <span class="nav-text">installAPIResources</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getAPIGroupVersion"><span class="nav-number">2.3.2.3.2.</span> <span class="nav-text">getAPIGroupVersion</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#InstallREST"><span class="nav-number">2.3.2.3.3.</span> <span class="nav-text">InstallREST</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#APIInstaller-Install-%E7%BB%91%E5%AE%9A%E8%B5%84%E6%BA%90%E7%9A%84path%E5%92%8Chandler"><span class="nav-number">2.3.2.3.4.</span> <span class="nav-text">APIInstaller.Install()绑定资源的path和handler</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAKubeAPIServer"><span class="nav-number">2.3.3.</span> <span class="nav-text">创建KubeAPIServer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%A6%82%E8%BF%B0-1"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">逻辑概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InstallLegacyAPI"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">InstallLegacyAPI</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#NewLegacyRESTStorage"><span class="nav-number">2.3.3.2.1.</span> <span class="nav-text">NewLegacyRESTStorage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#InstallLegacyAPIGroup"><span class="nav-number">2.3.3.2.2.</span> <span class="nav-text">InstallLegacyAPIGroup</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InstallAPIs"><span class="nav-number">2.3.3.3.</span> <span class="nav-text">InstallAPIs</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAAggregatorServer"><span class="nav-number">2.3.4.</span> <span class="nav-text">创建AggregatorServer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%A6%82%E8%BF%B0-2"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">逻辑概述</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96aggregatorServer"><span class="nav-number">2.3.4.1.1.</span> <span class="nav-text">实例化aggregatorServer</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#kube-aggregator%E7%9A%84clientset"><span class="nav-number">2.3.4.1.1.1.</span> <span class="nav-text">kube-aggregator的clientset</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAautoRegistrationController"><span class="nav-number">2.3.4.1.2.</span> <span class="nav-text">创建autoRegistrationController</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#syncHandler-checkAPIService"><span class="nav-number">2.3.4.1.2.1.</span> <span class="nav-text">syncHandler(checkAPIService)</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BACRDRegistrationController"><span class="nav-number">2.3.4.1.3.</span> <span class="nav-text">创建CRDRegistrationController</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%90%AF%E5%8A%A8"><span class="nav-number">2.4.</span> <span class="nav-text">准备启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">2.5.</span> <span class="nav-text">启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#s-NonBlockingRun"><span class="nav-number">2.5.1.</span> <span class="nav-text">s.NonBlockingRun</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="大力运天地"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">大力运天地</p>
  <div class="site-description" itemprop="description">大力运天地，羲和无停鞭。功名不早著，竹帛将何宣。</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Owl0214" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Owl0214" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yurunqi94@sina.com" title="E-Mail → mailto:yurunqi94@sina.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



          </div>
        </div>
      </div>


    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://owl0214.github.io/2021/08/30/Kubernetes/K8S/kube-apiserver%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E5%95%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="大力运天地">
      <meta itemprop="description" content="大力运天地，羲和无停鞭。功名不早著，竹帛将何宣。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="琦闻E事">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          apiserver启动分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-30 2021-08-30T14:11:19+08:00" itemprop="dateCreated datePublished" datetime="2021-08-30T14:11:19+08:00">2021-08-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/kube-apiserver%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E5%95%A5/" itemprop="url" rel="index"><span itemprop="name">kube-apiserver都做了些啥</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">apiserver启动时，主要步骤为注册资源->Cobra解析配置->创建ServerChain->准备启动->启动</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="kube-apiserver"><a href="#kube-apiserver" class="headerlink" title="kube-apiserver"></a>kube-apiserver</h1><p>apiserver是k8s的中心组件，它以RESTful API的形式提供了各类资源对象的操作接口。其他组件或者客户端(如kubectl)都会去调用它。apiserver支持同时提供https(默认监听6443端口)和http(默认监听8080端口)。其中http API是非安全结构，不做任何认证授权机制。</p>
<p>它的主要功能是：</p>
<ol>
<li>认证授权<ul>
<li> 通过认证插件<strong>认证客户端</strong>：客户端发送请求，apiserver通过配置的一个或多个认证插件，轮流调用这些插件，直到有一个插件认证通过。主要通过检查HTTP请求实现，可以从HTTP头或者客户端证书中获取用户信息，插件获得客户端的用户名、用户id和归属组来进行认证。</li>
<li> 通过授权插件<strong>授权客户端</strong>：apiserver通过配置一个或多个授权插件，对已经认证的客户端进行认证，决定其是否能对请求的资源执行相应的操作</li>
<li> 通过准入控制插件<strong>验证修改资源请求</strong>：当客户端请求尝试<strong>创建、修改、删除</strong>资源时，请求需要经过准入控。制插件的验证。apiserver会配置多个准入控制插件，<strong>请求需要经过所有准入控制插件的验证</strong>。如果请求是读取数据，则不会做准入控制验证。</li>
</ul>
</li>
<li>变更通知：<ul>
<li>客户端通过创建到apiserver的HTTP连接来监听资源变更，通过连接，客户端会接收到监听对象的一系列变更通知。当对象发生变化，apiserver会把新版本的对象发送至所有监听该对象的客户端。</li>
</ul>
</li>
<li>组件通信：<ul>
<li>k8s系统的组件，只能通过apiserver进行通信，组件间不会直接通信。<strong>apiserver是唯一与etcd通信的组件</strong>，其他组件不会与etcd做通信，而是通过与apiserver通信，来进行对资源对象的修改。</li>
</ul>
</li>
</ol>
<h2 id="kube-apiserver架构"><a href="#kube-apiserver架构" class="headerlink" title="kube-apiserver架构"></a>kube-apiserver架构</h2><p>apiserver提供了3种HTTP Server服务，APIExtensionsServer、KubeAPIServer、AggregatorServer。不同服务的应用场景不同，提供的资源也不同。</p>
<ul>
<li>APIExtensionsServer：API扩展服务(扩展器)。提供了CRD自定义服务，可通过CRD对Kubernetes资源进行扩展。该服务通过CustomResourceDefinitions对象进行管理，并通过extensionsapiserver.Scheme资源注册表管理CRD相关资源。</li>
<li>KubeAPIServer：API核心服务。提供了Kubernetes内置核心资源服务，不允许开发者随意更改相关资源。API核心服务通过Master对象进行管理，并通过legacyscheme.Scheme资源注册表管理Master相关资源。</li>
<li>AggregatorServer：将用户扩展的API注册到apiserver，为其提供服务发现。通过API聚合层APIAggregator(AA)将扩展API的访问请求转发到用户扩展的服务上。</li>
</ul>
<hr>
<ul>
<li>GenericAPIServer：APIExtensionsServer、KubeAPIServer、AggregatorServer都基于GenericAPIServer进行创建。通过GenericAPIServer可以将Kubernetes资源与REST API进行映射。</li>
</ul>
<h1 id="apiserver启动流程分析"><a href="#apiserver启动流程分析" class="headerlink" title="apiserver启动流程分析"></a>apiserver启动流程分析</h1><p>相关源码参照kubernetes 1.20.4</p>
<h2 id="注册k8s所支持的资源"><a href="#注册k8s所支持的资源" class="headerlink" title="注册k8s所支持的资源"></a>注册k8s所支持的资源</h2><p>首先，kubernetes支持的资源需要注册到Scheme资源注册表中，启动时，才能从Scheme中拿到资源信息，并启动、运行AggregatorServer、APIExtensionsServer、KubeAPIServer。资源的注册，是通过Go的import和init触发的。</p>
<ol>
<li><code>cmd/kube-apiserver/app/server.go</code>中，导入了<code>&quot;k8s.io/kubernetes/pkg/api/legacyscheme&quot;</code>包，该包中定义了全局的<strong>Scheme资源注册表</strong>、<strong>Codec编解码器</strong>、<strong>ParameterCodec参数编解码器</strong>。 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> legacyscheme</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">  <span class="string">&quot;k8s.io/apimachinery/pkg/runtime/serializer&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  Scheme = runtime.NewScheme()</span><br><span class="line">  Codecs = serializer.NewCodecFactory(Scheme)</span><br><span class="line">  ParameterCodec = runtime.NewParameterCodec(Scheme)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
<li>通过导入<code>&quot;k8s.io/kubernetes/pkg/controlplane&quot;</code>注册资源。controlplane导入了apiserver支持的API groups包，通过导入包的机制，触发其初始化函数，进行资源的注册。例如，在controlplane的<code>import_known_versions.go</code>，导入了<code>k8s.io/kubernetes/pkg/apis/admission/install</code>。这个install文件实际上就是将相应的资源通过AddToScheme方法，添加到Scheme资源注册表中。 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> install</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span></span><br><span class="line">  utilruntime <span class="string">&quot;k8s.io/apimachinery/pkg/util/runtime&quot;</span></span><br><span class="line">  <span class="string">&quot;k8s.io/kubernetes/pkg/api/legacyscheme&quot;</span></span><br><span class="line">  <span class="string">&quot;k8s.io/kubernetes/pkg/apis/admission&quot;</span></span><br><span class="line">  v1 <span class="string">&quot;k8s.io/kubernetes/pkg/apis/admission/v1&quot;</span></span><br><span class="line">  <span class="string">&quot;k8s.io/kubernetes/pkg/apis/admission/v1beta1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  Install(legacyscheme.Scheme)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Install registers the API group and adds types to a scheme</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Install</span><span class="params">(scheme *runtime.Scheme)</span></span> &#123;</span><br><span class="line">  utilruntime.Must(admission.AddToScheme(scheme))</span><br><span class="line">  utilruntime.Must(v1beta1.AddToScheme(scheme))</span><br><span class="line">  utilruntime.Must(v1.AddToScheme(scheme))</span><br><span class="line">  utilruntime.Must(scheme.SetVersionPriority(v1.SchemeGroupVersion, v1beta1.SchemeGroupVersion))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Cobra命令行解析"><a href="#Cobra命令行解析" class="headerlink" title="Cobra命令行解析"></a>Cobra命令行解析</h2><p>apiserver.go的main方法主要是通过cobra进行执行启动命令。通过调用NewAPIServerCommand()方法，对apiserver配置进行默认值填充和验证。在该方法中，会通过NewServerRunOptions配置参数默认值，然后将options传给command。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAPIServerCommand</span><span class="params">()</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">  <span class="comment">// 资源组件配置默认值填充</span></span><br><span class="line">  s := options.NewServerRunOptions()</span><br><span class="line">  <span class="comment">// 构建命令行命令，将参数传递给command</span></span><br><span class="line">  cmd := &amp;cobra.Command&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// 设置apiserver默认启动的options</span></span><br><span class="line">    completedOptions, err := Complete(s)</span><br><span class="line">    <span class="keyword">if</span> errs := completedOptions.Validate(); <span class="built_in">len</span>(errs) != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> utilerrors.NewAggregate(errs)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// cobra生成的命令实现的功能方法</span></span><br><span class="line">    RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">      ......</span><br><span class="line">      <span class="keyword">return</span> Run(completedOptions, genericapiserver.SetupSignalHandler())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">return</span> cmd</span><br></pre></td></tr></table></figure>
<p>apiserver的main方法中，最终会调用cobra.Execute()执行这个命令进行启动。启动时，cobra会调用Run()方法，Run()方法主要做了3件事<code>server:=CreateServerChain</code>、<code>server.PrepareRun</code>和<code>server.Run</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UnixNano())</span><br><span class="line">	command := app.NewAPIServerCommand()</span><br><span class="line">	logs.InitLogs()</span><br><span class="line">	<span class="keyword">defer</span> logs.FlushLogs()</span><br><span class="line">	<span class="keyword">if</span> err := command.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建ServerChain"><a href="#创建ServerChain" class="headerlink" title="创建ServerChain"></a>创建ServerChain</h2><p>CreateServerChain主要对KubeAPIServer、APIExtensionServer、AggregatorServer进行了创建。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateServerChain</span><span class="params">(completedOptions completedServerRunOptions, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(*aggregatorapiserver.APIAggregator, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 根据options的SSHUser和SSHKeyfile，与Node进行连接</span></span><br><span class="line">	nodeTunneler, proxyTransport, err := CreateNodeDialer(completedOptions)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建运行apiserver需要的资源</span></span><br><span class="line">	kubeAPIServerConfig, serviceResolver, pluginInitializer, err := CreateKubeAPIServerConfig(completedOptions, nodeTunneler, proxyTransport)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建APIExtensionServer需要的资源</span></span><br><span class="line">	apiExtensionsConfig, err := createAPIExtensionsConfig(*kubeAPIServerConfig.GenericConfig, kubeAPIServerConfig.ExtraConfig.VersionedInformers, pluginInitializer, completedOptions.ServerRunOptions, completedOptions.MasterCount,</span><br><span class="line">		serviceResolver, webhook.NewDefaultAuthenticationInfoResolverWrapper(proxyTransport, kubeAPIServerConfig.GenericConfig.EgressSelector, kubeAPIServerConfig.GenericConfig.LoopbackClientConfig))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建APIExtensionServer</span></span><br><span class="line">	apiExtensionsServer, err := createAPIExtensionsServer(apiExtensionsConfig, genericapiserver.NewEmptyDelegate())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建KubeAPIServer</span></span><br><span class="line">	kubeAPIServer, err := CreateKubeAPIServer(kubeAPIServerConfig, apiExtensionsServer.GenericAPIServer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建AggregatorServer需要的资源</span></span><br><span class="line">	aggregatorConfig, err := createAggregatorConfig(*kubeAPIServerConfig.GenericConfig, completedOptions.ServerRunOptions, kubeAPIServerConfig.ExtraConfig.VersionedInformers, serviceResolver, proxyTransport, pluginInitializer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建AggregatorServer</span></span><br><span class="line">	aggregatorServer, err := createAggregatorServer(aggregatorConfig, kubeAPIServer.GenericAPIServer, apiExtensionsServer.Informers)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// we don&#x27;t need special handling for innerStopCh because the aggregator server doesn&#x27;t create any go routines</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> aggregatorServer, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建通用配置"><a href="#创建通用配置" class="headerlink" title="创建通用配置"></a>创建通用配置</h3><p>ServerRunOptions包含了apiserver启动需要的所有参数，主要配置主要包括：</p>
<ul>
<li>genericoptions，比如Etcd、SecureServing、Audit、Features等</li>
<li>kubeoptions,Admission、Authentication、Authorization、CloudProvider等</li>
<li>metrics：采集的配置</li>
<li>logs：日志的配置</li>
<li>kubeletConfig：kubeletclient的config，比如port,node的hostname,ip，连接超时时间等</li>
<li>SSHKeyfile</li>
<li>SSHUser</li>
<li>ProxyClientCertFile</li>
<li>ProxyClientKeyFile</li>
</ul>
<p>CreateKubeAPIServerConfig主要完成apiserver的基础配置，这些配置信息来源于<code>kube-apiserver.yaml</code>中的<code>command</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-apiserver/app/server.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateKubeAPIServerConfig</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	s completedServerRunOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">	nodeTunneler tunneler.Tunneler,</span></span></span><br><span class="line"><span class="params"><span class="function">	proxyTransport *http.Transport,</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	*controlplane.Config,</span></span></span><br><span class="line"><span class="params"><span class="function">	aggregatorapiserver.ServiceResolver,</span></span></span><br><span class="line"><span class="params"><span class="function">	[]admission.PluginInitializer,</span></span></span><br><span class="line"><span class="params"><span class="function">	error,</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 根据配置信息，初始化genericConfig等信息</span></span><br><span class="line">	genericConfig, versionedInformers, serviceResolver, pluginInitializers, admissionPostStartHook, storageFactory, err := buildGenericConfig(s.ServerRunOptions, proxyTransport)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// 存储配置</span></span><br><span class="line">	<span class="keyword">if</span> _, port, err := net.SplitHostPort(s.Etcd.StorageConfig.Transport.ServerList[<span class="number">0</span>]); err == <span class="literal">nil</span> &amp;&amp; port != <span class="string">&quot;0&quot;</span> &amp;&amp; <span class="built_in">len</span>(port) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := utilwait.PollImmediate(etcdRetryInterval, etcdRetryLimit*etcdRetryInterval, preflight.EtcdConnection&#123;ServerList: s.Etcd.StorageConfig.Transport.ServerList&#125;.CheckEtcdServers); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;error waiting for etcd connection: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// ip范围设置</span></span><br><span class="line">	serviceIPRange, apiServerServiceIP, err := controlplane.ServiceIPRange(s.PrimaryServiceClusterIPRange)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">	config := &amp;controlplane.Config&#123;</span><br><span class="line">		GenericConfig: genericConfig,</span><br><span class="line">		ExtraConfig: controlplane.ExtraConfig&#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 省略了其他配置</span></span><br><span class="line">	.......</span><br><span class="line">	<span class="keyword">return</span> config, serviceResolver, pluginInitializers, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建APIExtensionsServer"><a href="#创建APIExtensionsServer" class="headerlink" title="创建APIExtensionsServer"></a>创建APIExtensionsServer</h3><h4 id="逻辑概述"><a href="#逻辑概述" class="headerlink" title="逻辑概述"></a>逻辑概述</h4><ol>
<li>通过c.GenericConfig.New()创建一个名为<code>apiextensions-apiserver</code>的genericServer。            <ol>
<li>创建http请求处理链，用作对请求的处理，一般用来进行filter操作，比如身份验证和授权。</li>
<li>实例化一个<code>genericAPIServer</code>对象<code>s</code>，genericAPIServer</li>
<li>创建并将SharedInformerFactory添加到<code>s</code>的PostStartHook</li>
<li>创建将对请求的限流添加到<code>s</code>的PostStartHook</li>
<li>创建将healthz检测添加到<code>s</code>的PostStartHook</li>
<li>通过<code>installAPI</code>，将api暴露</li>
</ol>
</li>
<li>创建<code>CustomResourceDefinitions(CRD)</code>对象。</li>
<li>实例化<code>GroupName</code>为<code>apiextensions.k8s.io</code>的<code>APIGroupInfo</code>，只对<code>apiextensions.k8s.io</code>的资源进行管理。</li>
<li>为<code>APIGroupInfo</code>添加<code>RESTStorage</code>，<code>RESTStorage</code>通过<code>Storage Backend</code>访问etcd。</li>
<li>通过<code>s.GenericAPIServer.InstallAPIGroup</code>将CRD的资源服务加入到<code>gorestful container</code>中。其调用链为”InstallAPIGroup-&gt;InstallAPIGroups-&gt;InstallAPIResources-&gt;InstallREST-&gt;APIInstaller.Install”。大体逻辑为遍历<code>APIGroupInfo</code>，注册<code>APIGroup</code>。<code>InstallAPIGroup</code>遍历时将Group、Resource、Version，与路径<code>/apis</code>封装为<code>APIGroupVersion</code>。然后调用<code>InstallREST</code>方法，<code>InstallREST</code>调用<code>Install</code>将遍历<code>APIGroupInfo</code>，根据rest.Storage确定APIGroupInfo的<code>Verbs</code>（GET、WATCH、CREATE、DELETE、UPDATE等）,<code>APIGroupInfo</code>进行绑定，然后将其封装为<code>APIResource</code>。通过<code>Verbs</code>确定能对资源做哪些操作，再将这些操作的path和http请求类型，请求处理的handler，注册为一条条的<code>route</code>记录。然后再将routes放到<code>webseivice</code>中，通过<code>DiscoveryGroupManager</code>对该<code>webseivice</code>设置服务发现，最后将<code>webservice</code>放到<code>gorestful container</code>中。</li>
<li>定义CRD的<code>ClientSet</code>，并为其创建<code>SharedInformerFactory</code></li>
<li>定义crdHandler，为暴露的api注册handler，包括crdInformer的AddFun、UpdateFunc、DeleteFunc等</li>
<li>定义对clientset的一系列controller控制器</li>
<li>将informer和controller添加到PostStartHook中。PostStartHookFunc是一个钩子函数，在server启动时触发。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">New</span><span class="params">(delegationTarget genericapiserver.DelegationTarget)</span> <span class="params">(*CustomResourceDefinitions, error)</span></span> &#123;</span><br><span class="line">  	<span class="comment">// 创建genericServer</span></span><br><span class="line">	genericServer, err := c.GenericConfig.New(<span class="string">&quot;apiextensions-apiserver&quot;</span>, delegationTarget)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">  	<span class="comment">// 实例化CRD，CRD中包括了GenericServer和SharedInformerFactory</span></span><br><span class="line">	s := &amp;CustomResourceDefinitions&#123;</span><br><span class="line">		GenericAPIServer: genericServer,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	apiResourceConfig := c.GenericConfig.MergedResourceConfig</span><br><span class="line">  	<span class="comment">// 实例化APIGroupInfo，将GroupName设置为apiextensions.k8s.io</span></span><br><span class="line">	apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(apiextensions.GroupName, Scheme, metav1.ParameterCodec, Codecs)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分别为v1.apiextensions和v1beta.apiextensions的apiGroupInfo添加RESTStorage。用于与etcd交互的</span></span><br><span class="line">	<span class="keyword">if</span> apiResourceConfig.VersionEnabled(v1beta1.SchemeGroupVersion) &#123;</span><br><span class="line">		storage := <span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage&#123;&#125;</span><br><span class="line">		customResourceDefinitionStorage, err := customresourcedefinition.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		storage[<span class="string">&quot;customresourcedefinitions&quot;</span>] = customResourceDefinitionStorage</span><br><span class="line">		storage[<span class="string">&quot;customresourcedefinitions/status&quot;</span>] = customresourcedefinition.NewStatusREST(Scheme, customResourceDefinitionStorage)</span><br><span class="line">		apiGroupInfo.VersionedResourcesStorageMap[v1beta1.SchemeGroupVersion.Version] = storage</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> apiResourceConfig.VersionEnabled(v1.SchemeGroupVersion) &#123;</span><br><span class="line">    	......</span><br><span class="line">		apiGroupInfo.VersionedResourcesStorageMap[v1.SchemeGroupVersion.Version] = storage</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在路由中注册APIGroupInfo，对外暴露API</span></span><br><span class="line">	<span class="comment">// InstallAPIGroup方法直接返回s.InstallAPIGroups(apiGroupInfo)</span></span><br><span class="line">	<span class="keyword">if</span> err := s.GenericAPIServer.InstallAPIGroup(&amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	.....</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 为&#x27;/apis&#x27;资源组的service提供处理方法handler</span></span><br><span class="line">	crdHandler, err := NewCustomResourceDefinitionHandler(</span><br><span class="line">		versionDiscoveryHandler,</span><br><span class="line">		groupDiscoveryHandler,</span><br><span class="line">		s.Informers.Apiextensions().V1().CustomResourceDefinitions(),</span><br><span class="line">		delegateHandler,</span><br><span class="line">		c.ExtraConfig.CRDRESTOptionsGetter,</span><br><span class="line">		c.GenericConfig.AdmissionControl,</span><br><span class="line">		establishingController,</span><br><span class="line">		c.ExtraConfig.ServiceResolver,</span><br><span class="line">		c.ExtraConfig.AuthResolverWrapper,</span><br><span class="line">		c.ExtraConfig.MasterCount,</span><br><span class="line">		s.GenericAPIServer.Authorizer,</span><br><span class="line">		c.GenericConfig.RequestTimeout,</span><br><span class="line">		time.Duration(c.GenericConfig.MinRequestTimeout)*time.Second,</span><br><span class="line">		apiGroupInfo.StaticOpenAPISpec,</span><br><span class="line">		c.GenericConfig.MaxRequestBodyBytes,</span><br><span class="line">	)</span><br><span class="line">	s.GenericAPIServer.Handler.NonGoRestfulMux.Handle(<span class="string">&quot;/apis&quot;</span>, crdHandler)</span><br><span class="line">	s.GenericAPIServer.Handler.NonGoRestfulMux.HandlePrefix(<span class="string">&quot;/apis/&quot;</span>, crdHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 定义controller，CRD用来处理请求</span></span><br><span class="line">	discoveryController := NewDiscoveryController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), versionDiscoveryHandler, groupDiscoveryHandler)</span><br><span class="line">	namingController := status.NewNamingConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())</span><br><span class="line">	nonStructuralSchemaController := nonstructuralschema.NewConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())</span><br><span class="line">	apiApprovalController := apiapproval.NewKubernetesAPIApprovalPolicyConformantConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())</span><br><span class="line">	finalizingController := finalizer.NewCRDFinalizer(</span><br><span class="line">		s.Informers.Apiextensions().V1().CustomResourceDefinitions(),</span><br><span class="line">		crdClient.ApiextensionsV1(),</span><br><span class="line">		crdHandler,</span><br><span class="line">	)</span><br><span class="line">	openapiController := openapicontroller.NewController(s.Informers.Apiextensions().V1().CustomResourceDefinitions())</span><br><span class="line">	<span class="comment">// controller和informer添加到PostStartHook中，在server启动的时候，运行Controller</span></span><br><span class="line">	s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;start-apiextensions-informers&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		s.Informers.Start(context.StopCh)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;start-apiextensions-controllers&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> s.GenericAPIServer.OpenAPIVersionedService != <span class="literal">nil</span> &amp;&amp; s.GenericAPIServer.StaticOpenAPISpec != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">go</span> openapiController.Run(s.GenericAPIServer.StaticOpenAPISpec, s.GenericAPIServer.OpenAPIVersionedService, context.StopCh)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> namingController.Run(context.StopCh)</span><br><span class="line">		<span class="keyword">go</span> establishingController.Run(context.StopCh)</span><br><span class="line">		<span class="keyword">go</span> nonStructuralSchemaController.Run(<span class="number">5</span>, context.StopCh)</span><br><span class="line">		<span class="keyword">go</span> apiApprovalController.Run(<span class="number">5</span>, context.StopCh)</span><br><span class="line">		<span class="keyword">go</span> finalizingController.Run(<span class="number">5</span>, context.StopCh)</span><br><span class="line"></span><br><span class="line">		discoverySyncedCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">		<span class="keyword">go</span> discoveryController.Run(context.StopCh, discoverySyncedCh)</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-context.StopCh:</span><br><span class="line">		<span class="keyword">case</span> &lt;-discoverySyncedCh:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;crd-informer-synced&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> wait.PollImmediateUntil(<span class="number">100</span>*time.Millisecond, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> s.Informers.Apiextensions().V1().CustomResourceDefinitions().Informer().HasSynced(), <span class="literal">nil</span></span><br><span class="line">		&#125;, context.StopCh)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建GenericServer"><a href="#创建GenericServer" class="headerlink" title="创建GenericServer"></a>创建GenericServer</h4><ol>
<li>配置项检查</li>
<li>定义用于身份验证和授权的<code>handlerChainBuilder</code>请求处理链</li>
<li>创建handler，handler用于创建<code>gorestful container</code>，配置路由并将handler与路由关联。</li>
<li>创建<code>SharedInformerFactory</code>，用于给资源创建informer。并将其添加到PostStartrHook中</li>
<li>创建用于对资源请求的隔离、限流、健康检查的处理，并添加到PostStartHook中。</li>
<li>通过InstallAPI，进行资源暴露</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k8s.io/apiserver/pkg/server/config.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">New</span><span class="params">(name <span class="keyword">string</span>, delegationTarget DelegationTarget)</span> <span class="params">(*GenericAPIServer, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// completedConfig检查</span></span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// go-restful请求处理链，用来处理身份验证和授权等过滤</span></span><br><span class="line">	handlerChainBuilder := <span class="function"><span class="keyword">func</span><span class="params">(handler http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> c.BuildHandlerChainFunc(handler, c.Config)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// apiServer用来处理请求的handler</span></span><br><span class="line">	apiServerHandler := NewAPIServerHandler(name, c.Serializer, handlerChainBuilder, delegationTarget.UnprotectedHandler())</span><br><span class="line">	<span class="comment">// 根据config，配置genericAPIServer，并将apiServerHandler绑定到crd.genericAPIServer中</span></span><br><span class="line">	s := &amp;GenericAPIServer&#123;</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 添加hook</span></span><br><span class="line">	<span class="keyword">for</span> name, preconfiguredPostStartHook := <span class="keyword">range</span> c.PostStartHooks &#123;</span><br><span class="line">		<span class="keyword">if</span> err := s.AddPostStartHook(name, preconfiguredPostStartHook.hook); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建informers</span></span><br><span class="line">	genericApiServerHookName := <span class="string">&quot;generic-apiserver-start-informers&quot;</span></span><br><span class="line">	<span class="keyword">if</span> c.SharedInformerFactory != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !s.isPostStartHookRegistered(genericApiServerHookName) &#123;</span><br><span class="line">			err := s.AddPostStartHook(genericApiServerHookName, <span class="function"><span class="keyword">func</span><span class="params">(context PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">				<span class="comment">// context.StopCh给informer的channel提供信息</span></span><br><span class="line">				c.SharedInformerFactory.Start(context.StopCh)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 添加healthz检查</span></span><br><span class="line">		err := s.addReadyzChecks(healthz.NewInformerSyncHealthz(c.SharedInformerFactory))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> priorityAndFairnessConfigConsumerHookName = <span class="string">&quot;priority-and-fairness-config-consumer&quot;</span></span><br><span class="line">	<span class="keyword">if</span> s.isPostStartHookRegistered(priorityAndFairnessConfigConsumerHookName) &#123;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> c.FlowControl != <span class="literal">nil</span> &#123;</span><br><span class="line">		err := s.AddPostStartHook(priorityAndFairnessConfigConsumerHookName, <span class="function"><span class="keyword">func</span><span class="params">(context PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			<span class="keyword">go</span> c.FlowControl.MaintainObservations(context.StopCh)</span><br><span class="line">			<span class="keyword">go</span> c.FlowControl.Run(context.StopCh)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// TODO(yue9944882): plumb pre-shutdown-hook for request-management system?</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;Not requested to run hook %s&quot;</span>, priorityAndFairnessConfigConsumerHookName)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.FlowControl != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// 添加APF对请求进行分类和隔离(限流机制，保护api被恶意请求消耗资源然后死掉)</span></span><br><span class="line">		<span class="keyword">const</span> priorityAndFairnessFilterHookName = <span class="string">&quot;priority-and-fairness-filter&quot;</span></span><br><span class="line">		<span class="keyword">if</span> !s.isPostStartHookRegistered(priorityAndFairnessFilterHookName) &#123;</span><br><span class="line">			err := s.AddPostStartHook(priorityAndFairnessFilterHookName, <span class="function"><span class="keyword">func</span><span class="params">(context PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">				genericfilters.StartPriorityAndFairnessWatermarkMaintenance(context.StopCh)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 默认添加max-in-flight，避免受到CPU和内存过载的影响</span></span><br><span class="line">		<span class="keyword">const</span> maxInFlightFilterHookName = <span class="string">&quot;max-in-flight-filter&quot;</span></span><br><span class="line">		<span class="keyword">if</span> !s.isPostStartHookRegistered(maxInFlightFilterHookName) &#123;</span><br><span class="line">			err := s.AddPostStartHook(maxInFlightFilterHookName, <span class="function"><span class="keyword">func</span><span class="params">(context PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">				genericfilters.StartMaxInFlightWatermarkMaintenance(context.StopCh)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加healthz检查</span></span><br><span class="line">	<span class="keyword">for</span> _, delegateCheck := <span class="keyword">range</span> delegationTarget.HealthzChecks() &#123;</span><br><span class="line">		skip := <span class="literal">false</span></span><br><span class="line">		<span class="keyword">for</span> _, existingCheck := <span class="keyword">range</span> c.HealthzChecks &#123;</span><br><span class="line">			<span class="keyword">if</span> existingCheck.Name() == delegateCheck.Name() &#123;</span><br><span class="line">				skip = <span class="literal">true</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> skip &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		s.AddHealthChecks(delegateCheck)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// api的path集合</span></span><br><span class="line">	s.listedPathProvider = routes.ListedPathProviders&#123;s.listedPathProvider, delegationTarget&#125;</span><br><span class="line">	<span class="comment">// 暴露api</span></span><br><span class="line">	installAPI(s, c.Config)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use the UnprotectedHandler from the delegation target to ensure that we don&#x27;t attempt to double authenticator, authorize,</span></span><br><span class="line">	<span class="comment">// or some other part of the filter chain in delegation cases.</span></span><br><span class="line">	<span class="keyword">if</span> delegationTarget.UnprotectedHandler() == <span class="literal">nil</span> &amp;&amp; c.EnableIndex &#123;</span><br><span class="line">		s.Handler.NonGoRestfulMux.NotFoundHandler(routes.IndexLister&#123;</span><br><span class="line">			StatusCode:   http.StatusNotFound,</span><br><span class="line">			PathProvider: s.listedPathProvider,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="InstallAPI"><a href="#InstallAPI" class="headerlink" title="InstallAPI"></a>InstallAPI</h5><ul>
<li><code>routes.Index&#123;&#125;.Install()</code>，暴露了<code>&quot;/&quot;</code>,<code>&quot;/index.html&quot;</code>，用于获取apiservice索引页面。可以通过浏览器访问”<code>http://ip:8080</code>“查看。</li>
<li><code>routes.Profiling&#123;&#125;.Install()</code>，暴露了<code>&quot;/debug/pprof&quot;</code>性能分析页面。包含的path有:<code>&quot;/debug/pprof/&quot;</code>,<code>&quot;/debug/pprof/profile&quot;</code>,<code>&quot;/debug/pprof/profile&quot;</code>,<code>&quot;/debug/pprof/profile&quot;</code>。可以通过浏览器访问”<code>http://ip:8080/debug/pprof/</code>“查看。</li>
<li><code>routes.MetricsWithReset&#123;&#125;.Install()</code>或<code>routes.DefaultMetrics&#123;&#125;.Install()</code>，暴露了<code>&quot;/metrics&quot;</code>。可以通过浏览器访问”<code>http://ip:8080/</code>“查看。</li>
<li>添加服务注册管理</li>
<li>添加APF流量控制机制</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apiserver/pkg/server/config.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">installAPI</span><span class="params">(s *GenericAPIServer, c *Config)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> c.EnableIndex &#123;</span><br><span class="line">		routes.Index&#123;&#125;.Install(s.listedPathProvider, s.Handler.NonGoRestfulMux)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> c.EnableProfiling &#123;</span><br><span class="line">		routes.Profiling&#123;&#125;.Install(s.Handler.NonGoRestfulMux)</span><br><span class="line">		<span class="keyword">if</span> c.EnableContentionProfiling &#123;</span><br><span class="line">			goruntime.SetBlockProfileRate(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		routes.DebugFlags&#123;&#125;.Install(s.Handler.NonGoRestfulMux, <span class="string">&quot;v&quot;</span>, routes.StringFlagPutHandler(logs.GlogSetter))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> c.EnableMetrics &#123;</span><br><span class="line">		<span class="keyword">if</span> c.EnableProfiling &#123;</span><br><span class="line">			routes.MetricsWithReset&#123;&#125;.Install(s.Handler.NonGoRestfulMux)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			routes.DefaultMetrics&#123;&#125;.Install(s.Handler.NonGoRestfulMux)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	routes.Version&#123;Version: c.Version&#125;.Install(s.Handler.GoRestfulContainer)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.EnableDiscovery &#123;</span><br><span class="line">		s.Handler.GoRestfulContainer.Add(s.DiscoveryGroupManager.WebService())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> c.FlowControl != <span class="literal">nil</span> &amp;&amp; feature.DefaultFeatureGate.Enabled(features.APIPriorityAndFairness) &#123;</span><br><span class="line">		c.FlowControl.Install(s.Handler.NonGoRestfulMux)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="InstallAPIGroups的主要处理"><a href="#InstallAPIGroups的主要处理" class="headerlink" title="InstallAPIGroups的主要处理"></a>InstallAPIGroups的主要处理</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InstallAPIGroups的主要处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">InstallAPIGroups</span><span class="params">(apiGroupInfos ...*APIGroupInfo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	openAPIModels, err := s.getOpenAPIModels(APIGroupPrefix, apiGroupInfos...)</span><br><span class="line">    <span class="keyword">for</span> _, apiGroupInfo := <span class="keyword">range</span> apiGroupInfos &#123;</span><br><span class="line">      <span class="keyword">if</span> err := s.installAPIResources(APIGroupPrefix, apiGroupInfo, openAPIModels); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to install api resources: %v&quot;</span>, err)</span><br><span class="line">      &#125;</span><br><span class="line">      ......</span><br><span class="line">      s.DiscoveryGroupManager.AddGroup(apiGroup)</span><br><span class="line">      s.Handler.GoRestfulContainer.Add(discovery.NewAPIGroupHandler(s.Serializer, apiGroup).WebService())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h5 id="installAPIResources"><a href="#installAPIResources" class="headerlink" title="installAPIResources"></a>installAPIResources</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//k8s.io/apiserver/pkg/server/genericapiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">installAPIResources</span><span class="params">(apiPrefix <span class="keyword">string</span>, apiGroupInfo *APIGroupInfo, openAPIModels openapiproto.Models)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> resourceInfos []*storageversion.ResourceInfo</span><br><span class="line">	<span class="keyword">for</span> _, groupVersion := <span class="keyword">range</span> apiGroupInfo.PrioritizedVersions &#123;</span><br><span class="line">		......</span><br><span class="line">		</span><br><span class="line">		apiGroupVersion := s.getAPIGroupVersion(apiGroupInfo, groupVersion, apiPrefix)</span><br><span class="line"></span><br><span class="line">		......</span><br><span class="line">		<span class="comment">// 注册restful api的处理方法</span></span><br><span class="line">		r, err := apiGroupVersion.InstallREST(s.Handler.GoRestfulContainer)</span><br><span class="line">		......</span><br><span class="line"></span><br><span class="line">		resourceInfos = <span class="built_in">append</span>(resourceInfos, r...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="getAPIGroupVersion"><a href="#getAPIGroupVersion" class="headerlink" title="getAPIGroupVersion"></a>getAPIGroupVersion</h5><p>将<code>APIGroupInfo</code>封装为<code>APIGroupVersion</code>，为其添加一个<code>RESTful Storage</code>。这个Storage主要用于存放该组资源的信息，从版本到资源再到存储的映射。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//apiserver/pkg/server/genericapiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">getAPIGroupVersion</span><span class="params">(apiGroupInfo *APIGroupInfo, groupVersion schema.GroupVersion, apiPrefix <span class="keyword">string</span>)</span> *<span class="title">genericapi</span>.<span class="title">APIGroupVersion</span></span> &#123;</span><br><span class="line">	storage := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage)</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> apiGroupInfo.VersionedResourcesStorageMap[groupVersion.Version] &#123;</span><br><span class="line">		storage[strings.ToLower(k)] = v</span><br><span class="line">	&#125;</span><br><span class="line">	version := s.newAPIGroupVersion(apiGroupInfo, groupVersion)</span><br><span class="line">	version.Root = apiPrefix</span><br><span class="line">	version.Storage = storage</span><br><span class="line">	<span class="keyword">return</span> version</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="InstallREST"><a href="#InstallREST" class="headerlink" title="InstallREST"></a>InstallREST</h5><p><code>InstallREST</code>将<code>REST handlers</code>(storage, watch, proxy and redirect)注册到<code>RESTful Container</code>中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k8s.io/apiserver/pkg/endpoints/groupversion.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *APIGroupVersion)</span> <span class="title">InstallREST</span><span class="params">(container *restful.Container)</span> <span class="params">([]*storageversion.ResourceInfo, error)</span></span> &#123;</span><br><span class="line">	prefix := path.Join(g.Root, g.GroupVersion.Group, g.GroupVersion.Version)</span><br><span class="line">	installer := &amp;APIInstaller&#123;</span><br><span class="line">		group:             g,</span><br><span class="line">		prefix:            prefix,</span><br><span class="line">		minRequestTimeout: g.MinRequestTimeout,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 为API resources注册handlers，同时创建一个restful.WebService，把handlers注册到WebService中。Install()调用registerResourceHandlers，为资源绑定action和path</span></span><br><span class="line">	apiResources, resourceInfos, ws, registrationErrors := installer.Install()</span><br><span class="line">	versionDiscoveryHandler := discovery.NewAPIVersionHandler(g.Serializer, g.GroupVersion, staticLister&#123;apiResources&#125;)</span><br><span class="line">	versionDiscoveryHandler.AddToWebService(ws)</span><br><span class="line">	<span class="comment">// 将webservice注册到container中</span></span><br><span class="line">	container.Add(ws)</span><br><span class="line">	<span class="keyword">return</span> removeNonPersistedResources(resourceInfos), utilerrors.NewAggregate(registrationErrors)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="APIInstaller-Install-绑定资源的path和handler"><a href="#APIInstaller-Install-绑定资源的path和handler" class="headerlink" title="APIInstaller.Install()绑定资源的path和handler"></a>APIInstaller.Install()绑定资源的path和handler</h5><p><code>installer.Install()</code>调用<code>install.registerResourceHandlers()</code>，根据rest.Storage判断资源可以执行的操作，然后将其放入<code>actions</code>中，再对<code>actions</code>遍历，使用restful的RouteFunction为action创建handler。然后将action和handler注册到<code>route</code>中，再将<code>route</code>注册到<code>webservice</code>中。<code>InstallREST()</code>通过<code>container.Add(ws)</code>会把这个<code>ws</code>注册到<code>restful.Container</code>中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *APIInstaller)</span> <span class="title">registerResourceHandlers</span><span class="params">(path <span class="keyword">string</span>, storage rest.Storage, ws *restful.WebService)</span> <span class="params">(*metav1.APIResource, *storageversion.ResourceInfo, error)</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// 为资源添加action</span></span><br><span class="line">	actions = appendIf(actions, action&#123;<span class="string">&quot;LIST&quot;</span>, resourcePath, resourceParams, namer, <span class="literal">false</span>&#125;, isLister)</span><br><span class="line">		actions = appendIf(actions, action&#123;<span class="string">&quot;POST&quot;</span>, resourcePath, resourceParams, namer, <span class="literal">false</span>&#125;, isCreater)</span><br><span class="line">		actions = appendIf(actions, action&#123;<span class="string">&quot;DELETECOLLECTION&quot;</span>, resourcePath, resourceParams, namer, <span class="literal">false</span>&#125;, isCollectionDeleter)</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">//  为action创建handler</span></span><br><span class="line">	<span class="keyword">for</span> _, action := <span class="keyword">range</span> actions &#123;</span><br><span class="line">		......</span><br><span class="line">		<span class="keyword">switch</span> action.Verb &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">			<span class="keyword">var</span> handler restful.RouteFunction</span><br><span class="line">			<span class="keyword">if</span> isGetterWithOptions &#123;</span><br><span class="line">				handler = restfulGetResourceWithOptions(getterWithOptions, reqScope, isSubresource)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				handler = restfulGetResource(getter, exporter, reqScope)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> needOverride &#123;</span><br><span class="line">				<span class="comment">// need change the reported verb</span></span><br><span class="line">				handler = metrics.InstrumentRouteFunc(verbOverrider.OverrideMetricsVerb(action.Verb), group, version, resource, subresource, requestScope, metrics.APIServerComponent, deprecated, removedRelease, handler)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				handler = metrics.InstrumentRouteFunc(action.Verb, group, version, resource, subresource, requestScope, metrics.APIServerComponent, deprecated, removedRelease, handler)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> enableWarningHeaders &#123;</span><br><span class="line">				handler = utilwarning.AddWarningsHandler(handler, warnings)</span><br><span class="line">			&#125;</span><br><span class="line">			doc := <span class="string">&quot;read the specified &quot;</span> + kind</span><br><span class="line">			<span class="comment">// </span></span><br><span class="line">			route := ws.GET(action.Path).To(handler).</span><br><span class="line">				Doc(doc).</span><br><span class="line">				Param(ws.QueryParameter(<span class="string">&quot;pretty&quot;</span>, <span class="string">&quot;If &#x27;true&#x27;, then the output is pretty printed.&quot;</span>)).</span><br><span class="line">				Operation(<span class="string">&quot;read&quot;</span>+namespaced+kind+strings.Title(subresource)+operationSuffix).</span><br><span class="line">				Produces(<span class="built_in">append</span>(storageMeta.ProducesMIMETypes(action.Verb), mediaTypes...)...).</span><br><span class="line">				Returns(http.StatusOK, <span class="string">&quot;OK&quot;</span>, producedObject).</span><br><span class="line">				Writes(producedObject)</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;LIST&quot;</span>:</span><br><span class="line">			......</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;PUT&quot;</span>:</span><br><span class="line">			......</span><br><span class="line">		......</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unrecognized action verb: %s&quot;</span>, action.Verb)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 将route注册到webservice中</span></span><br><span class="line">		<span class="keyword">for</span> _, route := <span class="keyword">range</span> routes &#123;</span><br><span class="line">			route.Metadata(ROUTE_META_GVK, metav1.GroupVersionKind&#123;</span><br><span class="line">				Group:   reqScope.Kind.Group,</span><br><span class="line">				Version: reqScope.Kind.Version,</span><br><span class="line">				Kind:    reqScope.Kind.Kind,</span><br><span class="line">			&#125;)</span><br><span class="line">			route.Metadata(ROUTE_META_ACTION, strings.ToLower(action.Verb))</span><br><span class="line">			ws.Route(route)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">return</span> &amp;apiResource, resourceInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建KubeAPIServer"><a href="#创建KubeAPIServer" class="headerlink" title="创建KubeAPIServer"></a>创建KubeAPIServer</h3><p><code>kube-apiserver</code>的创建逻辑与创建<code>apiextensions-apiserver</code>类似，<code>kube-apiserver</code>主要是为了对<code>&quot;/api&quot;</code>和<code>&quot;/apis&quot;</code>下的资源进行注册暴露。</p>
<h4 id="逻辑概述-1"><a href="#逻辑概述-1" class="headerlink" title="逻辑概述"></a>逻辑概述</h4><ol>
<li>通过<code>GenericConfig.New()</code>方法创建一个为<code>kube-apiserver</code>，方法逻辑与创建<code>apiextensions-apiserver</code>完全一致。</li>
<li>判断是否支持<code>logs</code>，支持的话，就添加<code>logs</code>的路由。</li>
<li>实例化<code>apiserver</code>对象<code>Instance</code>，将认证配置封装到<code>apiserver</code>对象中。</li>
<li>调用<code>InstallLegacyAPI</code>方法，注册apiserver的核心资源(core)，主要是<code>&quot;/api/v1&quot;</code>下的每个<code>resource</code>。核心资源的均声明于<code>k8s.io/client-go/kubernetes/typed/core/v1/</code>下。</li>
<li><code>[]RESTStorageProvider</code>中每一项<code>StorageProvider</code>在实例化时，都会创建一个带有<code>groupName</code>的<code>apiGroupInfo</code>，并为不同<code>version</code>创建Storage。将<code>[]RESTStorageProvider</code>传入<code>InstallAPIs</code>。</li>
<li>调用<code>InstallAPIs</code>方法中，遍历<code>RESTStorageProvider</code>列表，为每种资源封装<code>apiGroupInfo</code>，然后调用<code>InstallAPIGroups</code>将服务进行注册。</li>
<li>最后为<code>apiserver</code>添加用于身份认证、检测的<code>PostStartHook</code>。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k8s.io/apiserver/pkg/server/config.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">New</span><span class="params">(delegationTarget genericapiserver.DelegationTarget)</span> <span class="params">(*Instance, error)</span></span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// 实例化kube-apiserver</span></span><br><span class="line">	s, err := c.GenericConfig.New(<span class="string">&quot;kube-apiserver&quot;</span>, delegationTarget)</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// 注册logs路由</span></span><br><span class="line">	<span class="keyword">if</span> c.ExtraConfig.EnableLogsSupport &#123;</span><br><span class="line">		routes.Logs&#123;&#125;.Install(s.Handler.GoRestfulContainer)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// beta v1.20，开启SA服务发现，用于SA的token验证。</span></span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(features.ServiceAccountIssuerDiscovery) &#123;</span><br><span class="line">			md, err := serviceaccount.NewOpenIDMetadata(</span><br><span class="line">			c.ExtraConfig.ServiceAccountIssuerURL,</span><br><span class="line">			c.ExtraConfig.ServiceAccountJWKSURI,</span><br><span class="line">			c.GenericConfig.ExternalAddress,</span><br><span class="line">			c.ExtraConfig.ServiceAccountPublicKeys,</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 注册apiserver提供JWKS的URL路径，该JWKS包含可用于签署Kubernetes服务帐户密钥的公钥。</span></span><br><span class="line">			routes.NewOpenIDMetadataServer(md.ConfigJSON, md.PublicKeysetJSON).</span><br><span class="line">				Install(s.Handler.GoRestfulContainer)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// apiserver实例包含genericAPIServer和认证配置（验证普通客户端的身份的ClientCA、用来确定用户名的头信息RequestHeaderUsernameHeaders、kube-apiserver用来确定组的头信息RequestHeaderGroupHeaders、用来确定user.extra的头文件RequestHeaderExtraHeaderPrefixes、允许充当前端代理的Subject主题RequestHeaderAllowedNames、用来验证前端代理的requesttheaderca）</span></span><br><span class="line">	m := &amp;Instance&#123;</span><br><span class="line">		GenericAPIServer:          s,</span><br><span class="line">		ClusterAuthenticationInfo: c.ExtraConfig.ClusterAuthenticationInfo,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// LegacyAPI</span></span><br><span class="line">	<span class="keyword">if</span> c.ExtraConfig.APIResourceConfigSource.VersionEnabled(apiv1.SchemeGroupVersion) &#123;</span><br><span class="line">		legacyRESTStorageProvider := corerest.LegacyRESTStorageProvider&#123;</span><br><span class="line">			StorageFactory:              c.ExtraConfig.StorageFactory,</span><br><span class="line">			ProxyTransport:              c.ExtraConfig.ProxyTransport,</span><br><span class="line">			KubeletClientConfig:         c.ExtraConfig.KubeletClientConfig,</span><br><span class="line">			EventTTL:                    c.ExtraConfig.EventTTL,</span><br><span class="line">			ServiceIPRange:              c.ExtraConfig.ServiceIPRange,</span><br><span class="line">			SecondaryServiceIPRange:     c.ExtraConfig.SecondaryServiceIPRange,</span><br><span class="line">			ServiceNodePortRange:        c.ExtraConfig.ServiceNodePortRange,</span><br><span class="line">			LoopbackClientConfig:        c.GenericConfig.LoopbackClientConfig,</span><br><span class="line">			ServiceAccountIssuer:        c.ExtraConfig.ServiceAccountIssuer,</span><br><span class="line">			ExtendExpiration:            c.ExtraConfig.ExtendExpiration,</span><br><span class="line">			ServiceAccountMaxExpiration: c.ExtraConfig.ServiceAccountMaxExpiration,</span><br><span class="line">			APIAudiences:                c.GenericConfig.Authentication.APIAudiences,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := m.InstallLegacyAPI(&amp;c, c.GenericConfig.RESTOptionsGetter, legacyRESTStorageProvider); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 每一种资源的RESTStorageProvider存放了其不同version和path.</span></span><br><span class="line">	restStorageProviders := []RESTStorageProvider&#123;</span><br><span class="line">		apiserverinternalrest.StorageProvider&#123;&#125;,</span><br><span class="line">		authenticationrest.RESTStorageProvider&#123;Authenticator: c.GenericConfig.Authentication.Authenticator, APIAudiences: c.GenericConfig.Authentication.APIAudiences&#125;,</span><br><span class="line">		authorizationrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer, RuleResolver: c.GenericConfig.RuleResolver&#125;,</span><br><span class="line">		autoscalingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		batchrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		certificatesrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		coordinationrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		discoveryrest.StorageProvider&#123;&#125;,</span><br><span class="line">		extensionsrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		networkingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		noderest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		policyrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		rbacrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer&#125;,</span><br><span class="line">		schedulingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		storagerest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		flowcontrolrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		appsrest.StorageProvider&#123;&#125;,</span><br><span class="line">		admissionregistrationrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		eventsrest.RESTStorageProvider&#123;TTL: c.ExtraConfig.EventTTL&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//  暴露api</span></span><br><span class="line">	<span class="keyword">if</span> err := m.InstallAPIs(c.ExtraConfig.APIResourceConfigSource, c.GenericConfig.RESTOptionsGetter, restStorageProviders...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> c.ExtraConfig.Tunneler != <span class="literal">nil</span> &#123;</span><br><span class="line">		m.installTunneler(c.ExtraConfig.Tunneler, corev1client.NewForConfigOrDie(c.GenericConfig.LoopbackClientConfig).Nodes())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;start-cluster-authentication-info-controller&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(hookContext genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		......</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(apiserverfeatures.APIServerIdentity) &#123;</span><br><span class="line">		m.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;start-kube-apiserver-identity-lease-controller&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(hookContext genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">		m.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;start-kube-apiserver-identity-lease-garbage-collector&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(hookContext genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			......</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> m, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="InstallLegacyAPI"><a href="#InstallLegacyAPI" class="headerlink" title="InstallLegacyAPI"></a>InstallLegacyAPI</h4><ol>
<li>通过<code>NewLegacyRESTStorage</code>，声明一个资源组对象<code>apiGroupInfo</code>。然后为核心组的资源创建存储restStorage，比如通过调用<code>&#39;podstore.NewStorage&#39;</code>为pod资源创建一个<code>podStorage</code>，然后将其放入<code>restStorageMap</code>。最后将<code>apiGroupInfo</code>资源版本设置为v1，并将<code>restStorageMap</code>，赋值给核心组的<code>VersionedResourcesStorageMap``（VersionedResourcesStorageMap map[string]map[string]rest.Storage</code>，对外显示为<code>Version/Resource/RestStorage</code>），例如可以通过<code>&quot;http://ip:8080/api/v1/pods&quot;</code>查看存储的pod对象。</li>
<li>为<code>/api</code>下的资源注册路由，并绑定处理方法，以便对外提供RESTful API。调用链为”InstallLegacyAPI-&gt;InstallLegacyAPIGroup-&gt;installAPIResources-&gt;InstallREST-&gt;APIInstaller.Install”，逻辑与<code>APIExtensionsServer</code>注册路由的逻辑一致。</li>
<li>将routes添加到services中，然后将service添加到container中，对外提供服务。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/controlplane/instance.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Instance)</span> <span class="title">InstallLegacyAPI</span><span class="params">(c *completedConfig, restOptionsGetter generic.RESTOptionsGetter, legacyRESTStorageProvider corerest.LegacyRESTStorageProvider)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 为LegacyAPI中的资源定义RESTStorage，包括对Pod的资源存储类型</span></span><br><span class="line">	legacyRESTStorage, apiGroupInfo, err := legacyRESTStorageProvider.NewLegacyRESTStorage(restOptionsGetter)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error building core storage: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	controllerName := <span class="string">&quot;bootstrap-controller&quot;</span></span><br><span class="line">	<span class="comment">// 声明一个RESTClient</span></span><br><span class="line">	coreClient := corev1client.NewForConfigOrDie(c.GenericConfig.LoopbackClientConfig)</span><br><span class="line">	<span class="comment">// 初始化bootstrap-controller，Controller是核心引导Kubernetes控制器循环的控制器管理器，它管理创建“Kubernetes”服务、“default”、“kube-system”和“kube-public”名称空间，并提供对服务IP的IP修复检查</span></span><br><span class="line">	bootstrapController := c.NewBootstrapController(legacyRESTStorage, coreClient, coreClient, coreClient, coreClient.RESTClient())</span><br><span class="line">	m.GenericAPIServer.AddPostStartHookOrDie(controllerName, bootstrapController.PostStartHook)</span><br><span class="line">	m.GenericAPIServer.AddPreShutdownHookOrDie(controllerName, bootstrapController.PreShutdownHook)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Install &#x27;/api&#x27;下的路由</span></span><br><span class="line">	<span class="keyword">if</span> err := m.GenericAPIServer.InstallLegacyAPIGroup(genericapiserver.DefaultLegacyAPIPrefix, &amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering group versions: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="NewLegacyRESTStorage"><a href="#NewLegacyRESTStorage" class="headerlink" title="NewLegacyRESTStorage"></a>NewLegacyRESTStorage</h5><p>为核心组定义apiGroupInfo，并对组内的资源及其子资源创建restStorage，然后放到<code>restStorageMap</code>中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k8s.io/kubernetes/pkg/registry/core/rest/storage_core.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c LegacyRESTStorageProvider)</span> <span class="title">NewLegacyRESTStorage</span><span class="params">(restOptionsGetter generic.RESTOptionsGetter)</span> <span class="params">(LegacyRESTStorage, genericapiserver.APIGroupInfo, error)</span></span> &#123;</span><br><span class="line">	apiGroupInfo := genericapiserver.APIGroupInfo&#123;</span><br><span class="line">		PrioritizedVersions:          legacyscheme.Scheme.PrioritizedVersionsForGroup(<span class="string">&quot;&quot;</span>),</span><br><span class="line">		VersionedResourcesStorageMap: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage&#123;&#125;,</span><br><span class="line">		Scheme:                       legacyscheme.Scheme,</span><br><span class="line">		ParameterCodec:               legacyscheme.ParameterCodec,</span><br><span class="line">		NegotiatedSerializer:         legacyscheme.Codecs,</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">	podTemplateStorage, err := podtemplatestore.NewREST(restOptionsGetter)</span><br><span class="line">	...</span><br><span class="line">	eventStorage, err := eventstore.NewREST(restOptionsGetter, <span class="keyword">uint64</span>(c.EventTTL.Seconds()))</span><br><span class="line">	...</span><br><span class="line">	limitRangeStorage, err := limitrangestore.NewREST(restOptionsGetter)</span><br><span class="line">	...</span><br><span class="line">	namespaceStorage, namespaceStatusStorage, namespaceFinalizeStorage, err := namespacestore.NewREST(restOptionsGetter)</span><br><span class="line">	...</span><br><span class="line">	podStorage, err := podstore.NewStorage(restOptionsGetter,nodeStorage.KubeletConnectionInfo,c.ProxyTransport,podDisruptionClient)</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	restStorageMap := <span class="keyword">map</span>[<span class="keyword">string</span>]rest.Storage&#123;</span><br><span class="line">		<span class="string">&quot;pods&quot;</span>:             podStorage.Pod,</span><br><span class="line">		<span class="string">&quot;pods/attach&quot;</span>:      podStorage.Attach,</span><br><span class="line">		<span class="string">&quot;pods/status&quot;</span>:      podStorage.Status,</span><br><span class="line">		<span class="string">&quot;pods/log&quot;</span>:         podStorage.Log,</span><br><span class="line">		<span class="string">&quot;pods/exec&quot;</span>:        podStorage.Exec,</span><br><span class="line">		<span class="string">&quot;pods/portforward&quot;</span>: podStorage.PortForward,</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// 将核心组的version设置为v1</span></span><br><span class="line">	apiGroupInfo.VersionedResourcesStorageMap[<span class="string">&quot;v1&quot;</span>] = restStorageMap</span><br><span class="line">	<span class="keyword">return</span> restStorage, apiGroupInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="InstallLegacyAPIGroup"><a href="#InstallLegacyAPIGroup" class="headerlink" title="InstallLegacyAPIGroup"></a>InstallLegacyAPIGroup</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//apiserver/pkg/server/genericapiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">InstallLegacyAPIGroup</span><span class="params">(apiPrefix <span class="keyword">string</span>, apiGroupInfo *APIGroupInfo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !s.legacyAPIGroupPrefixes.Has(apiPrefix) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%q is not in the allowed legacy API prefixes: %v&quot;</span>, apiPrefix, s.legacyAPIGroupPrefixes.List())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 从apiGroupInfos中取出前缀为`api`的apiGroupInfo，通过utilopenapi.ToProtoModels，将其格式化为OpenAPI</span></span><br><span class="line">	openAPIModels, err := s.getOpenAPIModels(apiPrefix, apiGroupInfo)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to get openapi models: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 将REST (存储、监视、代理和重定向)注册到restful Container中</span></span><br><span class="line">	<span class="keyword">if</span> err := s.installAPIResources(apiPrefix, apiGroupInfo, openAPIModels); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	s.Handler.GoRestfulContainer.Add(discovery.NewLegacyRootAPIHandler(s.discoveryAddresses, s.Serializer, apiPrefix).WebService())</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="InstallAPIs"><a href="#InstallAPIs" class="headerlink" title="InstallAPIs"></a>InstallAPIs</h4><p>对每个apiGroupsInfo，调用<code>InstallAPIGroups</code>，对<code>/apis</code>下的<code>APIGroup</code>进行暴露。通过<code>installAPIResources</code>为每个<code>resource</code>注册<code>path</code>、<code>storage</code>、<code>handler</code>，并将其注册到<code>route</code>、<code>webservice</code>中。这部分处理流程与<code>installAPIResources</code>部分的流程一致。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/server/genericapiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">InstallAPIGroups</span><span class="params">(apiGroupInfos ...*APIGroupInfo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//空Group或空Version返回错误处理</span></span><br><span class="line">	......</span><br><span class="line">	<span class="comment">// 从apiGroupInfos中取出&quot;/apis&quot;前缀的APIGroupInfo，通过utilopenapi.ToProtoModels，将其格式化为OpenAPI</span></span><br><span class="line">	openAPIModels, err := s.getOpenAPIModels(APIGroupPrefix, apiGroupInfos...)</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">for</span> _, apiGroupInfo := <span class="keyword">range</span> apiGroupInfos &#123;</span><br><span class="line">		<span class="comment">// 调用installAPIResources</span></span><br><span class="line">		<span class="keyword">if</span> err := s.installAPIResources(APIGroupPrefix, apiGroupInfo, openAPIModels); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to install api resources: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 设置discovery</span></span><br><span class="line">		apiVersionsForDiscovery := []metav1.GroupVersionForDiscovery&#123;&#125;</span><br><span class="line">		<span class="keyword">for</span> _, groupVersion := <span class="keyword">range</span> apiGroupInfo.PrioritizedVersions &#123;</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(apiGroupInfo.VersionedResourcesStorageMap[groupVersion.Version]) == <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			apiVersionsForDiscovery = <span class="built_in">append</span>(apiVersionsForDiscovery, metav1.GroupVersionForDiscovery&#123;</span><br><span class="line">				GroupVersion: groupVersion.String(),</span><br><span class="line">				Version:      groupVersion.Version,</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		preferredVersionForDiscovery := metav1.GroupVersionForDiscovery&#123;</span><br><span class="line">			GroupVersion: apiGroupInfo.PrioritizedVersions[<span class="number">0</span>].String(),</span><br><span class="line">			Version:      apiGroupInfo.PrioritizedVersions[<span class="number">0</span>].Version,</span><br><span class="line">		&#125;</span><br><span class="line">		apiGroup := metav1.APIGroup&#123;</span><br><span class="line">			Name:             apiGroupInfo.PrioritizedVersions[<span class="number">0</span>].Group,</span><br><span class="line">			Versions:         apiVersionsForDiscovery,</span><br><span class="line">			PreferredVersion: preferredVersionForDiscovery,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		s.DiscoveryGroupManager.AddGroup(apiGroup)</span><br><span class="line">		s.Handler.GoRestfulContainer.Add(discovery.NewAPIGroupHandler(s.Serializer, apiGroup).WebService())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建AggregatorServer"><a href="#创建AggregatorServer" class="headerlink" title="创建AggregatorServer"></a>创建AggregatorServer</h3><h4 id="逻辑概述-2"><a href="#逻辑概述-2" class="headerlink" title="逻辑概述"></a>逻辑概述</h4><ol>
<li>创建<code>aggregatorServer</code>实例。</li>
<li>创建<code>apiregistrationClient</code>实例，实质为RESTClient</li>
<li>创建<code>crdRegistrationController</code>，它通过<code>AutoAPIServiceRegistration</code>来自动注册APIServices。aggregatorServer在启动时，会Run起5个goroutine，不断的对workequeue进行消费。在调用<code>checkService()</code>的时候，会把服务器的资源与cache上的做对比，然后根据比较结果，通过<code>apiRegistrationClient</code>对<code>apiService</code>进行操作。</li>
<li>通过<code>apiServicesToRegister</code>将apiService放入到队列中等待消费</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-apiserver/app/aggregator.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createAggregatorServer</span><span class="params">(aggregatorConfig *aggregatorapiserver.Config, delegateAPIServer genericapiserver.DelegationTarget, apiExtensionInformers apiextensionsinformers.SharedInformerFactory)</span> <span class="params">(*aggregatorapiserver.APIAggregator, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建aggregatorServer</span></span><br><span class="line">	aggregatorServer, err := aggregatorConfig.Complete().NewWithDelegate(delegateAPIServer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据LoopbackClientConfig配置创建apiRegistrationClient，</span></span><br><span class="line">	<span class="comment">// 这是一个RESTClient,REST是最基础的客户端。其对HTTP Request进行了封装，实现了RESTful风格的API。</span></span><br><span class="line">	<span class="comment">// 这个client用于与集群通信</span></span><br><span class="line">	apiRegistrationClient, err := apiregistrationclient.NewForConfig(aggregatorConfig.GenericConfig.LoopbackClientConfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建autoRegistrationController，用于将CRD对应的APIService自动注册到apiserver中</span></span><br><span class="line">	autoRegistrationController := autoregister.NewAutoRegisterController(aggregatorServer.APIRegistrationInformers.Apiregistration().V1().APIServices(), apiRegistrationClient)</span><br><span class="line">	<span class="comment">// 将每个apiService放入autoRegistrationController的sync队列中，在controller启动时，对apiServices进行添加</span></span><br><span class="line">	apiServices := apiServicesToRegister(delegateAPIServer, autoRegistrationController)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建crdRegistrationController，crdRegistrationController用autoRegistrationController注册CRD GroupVersions，这样它们就会自动保持同步</span></span><br><span class="line">	crdRegistrationController := crdregistration.NewCRDRegistrationController(</span><br><span class="line">		apiExtensionInformers.Apiextensions().V1().CustomResourceDefinitions(),</span><br><span class="line">		autoRegistrationController)</span><br><span class="line"></span><br><span class="line">	err = aggregatorServer.GenericAPIServer.AddPostStartHook(<span class="string">&quot;kube-apiserver-autoregistration&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="keyword">go</span> crdRegistrationController.Run(<span class="number">5</span>, context.StopCh)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> aggregatorConfig.GenericConfig.MergedResourceConfig.AnyVersionForGroupEnabled(<span class="string">&quot;apiextensions.k8s.io&quot;</span>) &#123;</span><br><span class="line">				crdRegistrationController.WaitForInitialSync()</span><br><span class="line">			&#125;</span><br><span class="line">			autoRegistrationController.Run(<span class="number">5</span>, context.StopCh)</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = aggregatorServer.GenericAPIServer.AddBootSequenceHealthChecks(</span><br><span class="line">		makeAPIServiceAvailableHealthCheck(</span><br><span class="line">			<span class="string">&quot;autoregister-completion&quot;</span>,</span><br><span class="line">			apiServices,</span><br><span class="line">			aggregatorServer.APIRegistrationInformers.Apiregistration().V1().APIServices(),</span><br><span class="line">		),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> aggregatorServer, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="实例化aggregatorServer"><a href="#实例化aggregatorServer" class="headerlink" title="实例化aggregatorServer"></a>实例化aggregatorServer</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//kube-aggregator/pkg/apiserver/apiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span> <span class="title">NewWithDelegate</span><span class="params">(delegationTarget genericapiserver.DelegationTarget)</span> <span class="params">(*APIAggregator, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 使用aggregatorServer自己的OpenAPI handler</span></span><br><span class="line">	<span class="comment">// 将默认的genericServer配置OpenAPI handler置为空</span></span><br><span class="line">	openAPIConfig := c.GenericConfig.OpenAPIConfig</span><br><span class="line">	c.GenericConfig.OpenAPIConfig = <span class="literal">nil</span></span><br><span class="line">	<span class="comment">// 创建kube-aggregator，此处逻辑与kube-apiserver和apiextensions-apiserver相同</span></span><br><span class="line">	genericServer, err := c.GenericConfig.New(<span class="string">&quot;kube-aggregator&quot;</span>, delegationTarget)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建一个apiregistrationClient，实质为一组RestClient</span></span><br><span class="line">	<span class="comment">// 用于与group为&#x27;apiregistration.k8s&#x27;的资源进行交互。</span></span><br><span class="line">	apiregistrationClient, err := clientset.NewForConfig(c.GenericConfig.LoopbackClientConfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// informerFactory用于创建Informer</span></span><br><span class="line">	informerFactory := informers.NewSharedInformerFactory(</span><br><span class="line">		apiregistrationClient,</span><br><span class="line">		<span class="number">5</span>*time.Minute, </span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	s := &amp;APIAggregator&#123;</span><br><span class="line">		GenericAPIServer:           genericServer,</span><br><span class="line">		delegateHandler:            delegationTarget.UnprotectedHandler(),</span><br><span class="line">		proxyTransport:             c.ExtraConfig.ProxyTransport,</span><br><span class="line">		proxyHandlers:              <span class="keyword">map</span>[<span class="keyword">string</span>]*proxyHandler&#123;&#125;,</span><br><span class="line">		handledGroups:              sets.String&#123;&#125;,</span><br><span class="line">		lister:                     informerFactory.Apiregistration().V1().APIServices().Lister(),</span><br><span class="line">		APIRegistrationInformers:   informerFactory,</span><br><span class="line">		serviceResolver:            c.ExtraConfig.ServiceResolver,</span><br><span class="line">		openAPIConfig:              openAPIConfig,</span><br><span class="line">		egressSelector:             c.GenericConfig.EgressSelector,</span><br><span class="line">		proxyCurrentCertKeyContent: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(bytes []<span class="keyword">byte</span>, bytes2 []<span class="keyword">byte</span>)</span></span> &#123; <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span> &#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义一个apiGroupInfo，其groupName为&quot;apiregistration.k8s.io&quot;，封装资源信息及访问存储的RESTStorage</span></span><br><span class="line">	apiGroupInfo := apiservicerest.NewRESTStorage(c.GenericConfig.MergedResourceConfig, c.GenericConfig.RESTOptionsGetter)</span><br><span class="line">	<span class="comment">// 调用InstallAPIGroups，对APIService进行暴露</span></span><br><span class="line">	<span class="keyword">if</span> err := s.GenericAPIServer.InstallAPIGroup(&amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	enabledVersions := sets.NewString()</span><br><span class="line">	<span class="keyword">for</span> v := <span class="keyword">range</span> apiGroupInfo.VersionedResourcesStorageMap &#123;</span><br><span class="line">		enabledVersions.Insert(v)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !enabledVersions.Has(v1.SchemeGroupVersion.Version) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;API group/version %s must be enabled&quot;</span>, v1.SchemeGroupVersion.String())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	apisHandler := &amp;apisHandler&#123;</span><br><span class="line">		codecs:         aggregatorscheme.Codecs,</span><br><span class="line">		lister:         s.lister,</span><br><span class="line">		discoveryGroup: discoveryGroup(enabledVersions),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 绑定过滤器</span></span><br><span class="line">	s.GenericAPIServer.Handler.NonGoRestfulMux.Handle(<span class="string">&quot;/apis&quot;</span>, apisHandler)</span><br><span class="line">	s.GenericAPIServer.Handler.NonGoRestfulMux.UnlistedHandle(<span class="string">&quot;/apis/&quot;</span>, apisHandler)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//实例化APIServiceRegistrationController，用来添加删除APIService</span></span><br><span class="line">	apiserviceRegistrationController := NewAPIServiceRegistrationController(informerFactory.Apiregistration().V1().APIServices(), s)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(c.ExtraConfig.ProxyClientCertFile) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(c.ExtraConfig.ProxyClientKeyFile) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		aggregatorProxyCerts, err := dynamiccertificates.NewDynamicServingContentFromFiles(<span class="string">&quot;aggregator-proxy-cert&quot;</span>, c.ExtraConfig.ProxyClientCertFile, c.ExtraConfig.ProxyClientKeyFile)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := aggregatorProxyCerts.RunOnce(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		aggregatorProxyCerts.AddListener(apiserviceRegistrationController)</span><br><span class="line">		s.proxyCurrentCertKeyContent = aggregatorProxyCerts.CurrentCertKeyContent</span><br><span class="line"></span><br><span class="line">		s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;aggregator-reload-proxy-client-cert&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			<span class="keyword">go</span> aggregatorProxyCerts.Run(<span class="number">1</span>, context.StopCh)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建AvailableConditionController，处理检查已注册API服务的可用性。</span></span><br><span class="line">	availableController, err := statuscontrollers.NewAvailableConditionController(</span><br><span class="line">		informerFactory.Apiregistration().V1().APIServices(),</span><br><span class="line">		c.GenericConfig.SharedInformerFactory.Core().V1().Services(),</span><br><span class="line">		c.GenericConfig.SharedInformerFactory.Core().V1().Endpoints(),</span><br><span class="line">		apiregistrationClient.ApiregistrationV1(),</span><br><span class="line">		c.ExtraConfig.ProxyTransport,</span><br><span class="line">		(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, []<span class="keyword">byte</span>)</span>)<span class="params">(s.proxyCurrentCertKeyContent)</span>,</span></span><br><span class="line">		s.serviceResolver,</span><br><span class="line">		c.GenericConfig.EgressSelector,</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 将informer、resgistrationController、和用于可用性检测的apiServiceStatusAvailableController添加到PostStartHook中</span></span><br><span class="line">	s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;start-kube-aggregator-informers&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		informerFactory.Start(context.StopCh)</span><br><span class="line">		c.GenericConfig.SharedInformerFactory.Start(context.StopCh)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;apiservice-registration-controller&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		handlerSyncedCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">		<span class="keyword">go</span> apiserviceRegistrationController.Run(context.StopCh, handlerSyncedCh)</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-context.StopCh:</span><br><span class="line">		<span class="keyword">case</span> &lt;-handlerSyncedCh:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;apiservice-status-available-controller&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">// if we end up blocking for long periods of time, we may need to increase threadiness.</span></span><br><span class="line">		<span class="keyword">go</span> availableController.Run(<span class="number">5</span>, context.StopCh)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> utilfeature.DefaultFeatureGate.Enabled(genericfeatures.StorageVersionAPI) &amp;&amp;</span><br><span class="line">		utilfeature.DefaultFeatureGate.Enabled(genericfeatures.APIServerIdentity) &#123;</span><br><span class="line">		<span class="comment">// 在AggregatorServer中开启一个goroutine用来更新资源的storage version</span></span><br><span class="line">		s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;built-in-resources-storage-version-updater&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(hookContext genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			kubeClient, err := kubernetes.NewForConfig(hookContext.LoopbackClientConfig)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err := wait.PollImmediateUntil(<span class="number">100</span>*time.Millisecond, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">				_, err := kubeClient.CoordinationV1().Leases(metav1.NamespaceSystem).Get(</span><br><span class="line">					context.TODO(), s.GenericAPIServer.APIServerID, metav1.GetOptions&#123;&#125;)</span><br><span class="line">				<span class="keyword">if</span> apierrors.IsNotFound(err) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">			&#125;, hookContext.StopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to wait for apiserver-identity lease %s to be created: %v&quot;</span>,</span><br><span class="line">					s.GenericAPIServer.APIServerID, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 正常情况，一个apiserver只在启动时更新一次storage version</span></span><br><span class="line">			<span class="comment">// storage version可能会被不同的代理修改或删除，每10分钟进行一次一致性的update操作</span></span><br><span class="line">			<span class="comment">// 如果没发生改变，这个一致性的update操作不会进行循环，并且被apiserver阻塞住</span></span><br><span class="line">			<span class="keyword">go</span> wait.PollImmediateUntil(<span class="number">10</span>*time.Minute, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">				<span class="comment">/** 所有apiserver (aggregator-apiserver, kube-apiserver</span></span><br><span class="line"><span class="comment">				 *  apiextensions-apiserver)共享相同的generic apiserver配置。</span></span><br><span class="line"><span class="comment">				 *  当generic apiserver安装api时，使用相同的StorageVersion管理器注册所有内置资源。</span></span><br><span class="line"><span class="comment">				 **/</span></span><br><span class="line">				s.GenericAPIServer.StorageVersionManager.UpdateStorageVersions(</span><br><span class="line">					 hookContext.LoopbackClientConfig, s.GenericAPIServer.APIServerID)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">			&#125;, hookContext.StopCh)</span><br><span class="line">			<span class="comment">// StorageVersionManager完成第一轮更新时，PostStartHook会返回unblock/healthz。</span></span><br><span class="line">			<span class="comment">// 处理程序不再阻塞write请求</span></span><br><span class="line">			wait.PollImmediateUntil(<span class="number">1</span>*time.Second, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">				<span class="keyword">return</span> s.GenericAPIServer.StorageVersionManager.Completed(), <span class="literal">nil</span></span><br><span class="line">			&#125;, hookContext.StopCh)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="kube-aggregator的clientset"><a href="#kube-aggregator的clientset" class="headerlink" title="kube-aggregator的clientset"></a>kube-aggregator的clientset</h6><p>Clientset根据为一个group中资源的不同Version，为其设置不同的restClient</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//k8s.io/kube-aggregator/pkg/client/clientset_generated/clientset/clientset.go</span></span><br><span class="line"><span class="keyword">type</span> Clientset <span class="keyword">struct</span> &#123;</span><br><span class="line">	*discovery.DiscoveryClient</span><br><span class="line">	apiregistrationV1beta1 *apiregistrationv1beta1.ApiregistrationV1beta1Client</span><br><span class="line">	apiregistrationV1      *apiregistrationv1.ApiregistrationV1Client</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建autoRegistrationController"><a href="#创建autoRegistrationController" class="headerlink" title="创建autoRegistrationController"></a>创建autoRegistrationController</h5><ul>
<li>apiServiceInformer提供对APIServices共享的informer和list的访问。</li>
<li>apiServiceClient是一个ClientSet，ClientSet封装了对Resource和Version的管理方法。每一个Resource和Version都以函数的方式暴露给开发者。<br>autoRegisterController负责将CRD(CustomResourceDefinition)对应的APIServices自动注册到apiserver上。其内部有一个queue，在启动时的时候，goroutine不断的对queue进行消费。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kube-aggregator/pkg/controllers/autoregister/autoregister_controller.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAutoRegisterController</span><span class="params">(apiServiceInformer informers.APIServiceInformer, apiServiceClient apiregistrationclient.APIServicesGetter)</span> *<span class="title">autoRegisterController</span></span> &#123;</span><br><span class="line">	<span class="comment">// 实例化autoRegisterController	</span></span><br><span class="line">	c := &amp;autoRegisterController&#123;</span><br><span class="line">		apiServiceLister:  apiServiceInformer.Lister(),</span><br><span class="line">		apiServiceSynced:  apiServiceInformer.Informer().HasSynced,</span><br><span class="line">		apiServiceClient:  apiServiceClient,</span><br><span class="line">		apiServicesToSync: <span class="keyword">map</span>[<span class="keyword">string</span>]*v1.APIService&#123;&#125;,</span><br><span class="line"></span><br><span class="line">		apiServicesAtStart: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>&#123;&#125;,</span><br><span class="line"></span><br><span class="line">		syncedSuccessfullyLock: &amp;sync.RWMutex&#123;&#125;,</span><br><span class="line">		syncedSuccessfully:     <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>&#123;&#125;,</span><br><span class="line">		<span class="comment">// delaying_queue</span></span><br><span class="line">		queue: workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), <span class="string">&quot;autoregister&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 对比服务器etcd和cache中的资源</span></span><br><span class="line">	c.syncHandler = c.checkAPIService</span><br><span class="line"></span><br><span class="line">	apiServiceInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">		AddFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			cast := obj.(*v1.APIService)</span><br><span class="line">			c.queue.Add(cast.Name)</span><br><span class="line">		&#125;,</span><br><span class="line">		UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(_, obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			cast := obj.(*v1.APIService)</span><br><span class="line">			c.queue.Add(cast.Name)</span><br><span class="line">		&#125;,</span><br><span class="line">		DeleteFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			cast, ok := obj.(*v1.APIService)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				tombstone, ok := obj.(cache.DeletedFinalStateUnknown)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;Couldn&#x27;t get object from tombstone %#v&quot;</span>, obj)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				cast, ok = tombstone.Obj.(*v1.APIService)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;Tombstone contained unexpected object: %#v&quot;</span>, obj)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			c.queue.Add(cast.Name)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="syncHandler-checkAPIService"><a href="#syncHandler-checkAPIService" class="headerlink" title="syncHandler(checkAPIService)"></a>syncHandler(checkAPIService)</h6><p>checkAPIService根据所需APIService对象列表同步当前APIService。</p>
<table>
<thead>
<tr>
<th></th>
<th>A. desired: not found</th>
<th>B. desired: sync on start</th>
<th>C. desired: sync always</th>
</tr>
</thead>
<tbody><tr>
<td>1. current: lookup error</td>
<td>error</td>
<td>error</td>
<td>error</td>
</tr>
<tr>
<td>2. current: not found</td>
<td>-</td>
<td>create once</td>
<td>create</td>
</tr>
<tr>
<td>3. current: no sync</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>4. current: sync on start, not present at start</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>5. current: sync on start, present at start</td>
<td>delete once</td>
<td>update once</td>
<td>update once</td>
</tr>
<tr>
<td>6. current: sync always</td>
<td>delete</td>
<td>update once</td>
<td>update</td>
</tr>
</tbody></table>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//kube-aggregator/pkg/controllers/autoregister/autoregister_controller.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *autoRegisterController)</span> <span class="title">checkAPIService</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 从cacheStorage中获取apiService</span></span><br><span class="line">	desired := c.GetAPIServiceToSync(name)</span><br><span class="line">	curr, err := c.apiServiceLister.Get(name)</span><br><span class="line">	<span class="comment">// if we&#x27;ve never synced this service successfully, record a successful sync.</span></span><br><span class="line">	hasSynced := c.hasSyncedSuccessfully(name)</span><br><span class="line">	<span class="keyword">if</span> !hasSynced &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">				c.setSyncedSuccessfully(name)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">	<span class="comment">// we had a real error, just return it (1A,1B,1C)</span></span><br><span class="line">	<span class="keyword">case</span> err != <span class="literal">nil</span> &amp;&amp; !apierrors.IsNotFound(err):</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line"></span><br><span class="line">	<span class="comment">// we don&#x27;t have an entry and we don&#x27;t want one (2A)</span></span><br><span class="line">	<span class="keyword">case</span> apierrors.IsNotFound(err) &amp;&amp; desired == <span class="literal">nil</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// the local object only wants to sync on start and has already synced (2B,5B,6B &quot;once&quot; enforcement)</span></span><br><span class="line">	<span class="keyword">case</span> isAutomanagedOnStart(desired) &amp;&amp; hasSynced:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// we don&#x27;t have an entry and we do want one (2B,2C)</span></span><br><span class="line">	<span class="keyword">case</span> apierrors.IsNotFound(err) &amp;&amp; desired != <span class="literal">nil</span>:</span><br><span class="line">		_, err := c.apiServiceClient.APIServices().Create(context.TODO(), desired, metav1.CreateOptions&#123;&#125;)</span><br><span class="line">		<span class="keyword">if</span> apierrors.IsAlreadyExists(err) &#123;</span><br><span class="line">			<span class="comment">// created in the meantime, we&#x27;ll get called again</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line"></span><br><span class="line">	<span class="comment">// we aren&#x27;t trying to manage this APIService (3A,3B,3C)</span></span><br><span class="line">	<span class="keyword">case</span> !isAutomanaged(curr):</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// the remote object only wants to sync on start, but was added after we started (4A,4B,4C)</span></span><br><span class="line">	<span class="keyword">case</span> isAutomanagedOnStart(curr) &amp;&amp; !c.apiServicesAtStart[name]:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// the remote object only wants to sync on start and has already synced (5A,5B,5C &quot;once&quot; enforcement)</span></span><br><span class="line">	<span class="keyword">case</span> isAutomanagedOnStart(curr) &amp;&amp; hasSynced:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// we have a spurious APIService that we&#x27;re managing, delete it (5A,6A)</span></span><br><span class="line">	<span class="keyword">case</span> desired == <span class="literal">nil</span>:</span><br><span class="line">		opts := metav1.DeleteOptions&#123;Preconditions: metav1.NewUIDPreconditions(<span class="keyword">string</span>(curr.UID))&#125;</span><br><span class="line">		err := c.apiServiceClient.APIServices().Delete(context.TODO(), curr.Name, opts)</span><br><span class="line">		<span class="keyword">if</span> apierrors.IsNotFound(err) || apierrors.IsConflict(err) &#123;</span><br><span class="line">			<span class="comment">// deleted or changed in the meantime, we&#x27;ll get called again</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if the specs already match, nothing for us to do</span></span><br><span class="line">	<span class="keyword">case</span> reflect.DeepEqual(curr.Spec, desired.Spec):</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// we have an entry and we have a desired, now we deconflict.  Only a few fields matter. (5B,5C,6B,6C)</span></span><br><span class="line">	apiService := curr.DeepCopy()</span><br><span class="line">	apiService.Spec = desired.Spec</span><br><span class="line">	_, err = c.apiServiceClient.APIServices().Update(context.TODO(), apiService, metav1.UpdateOptions&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> apierrors.IsNotFound(err) || apierrors.IsConflict(err) &#123;</span><br><span class="line">		<span class="comment">// deleted or changed in the meantime, we&#x27;ll get called again</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建CRDRegistrationController"><a href="#创建CRDRegistrationController" class="headerlink" title="创建CRDRegistrationController"></a>创建CRDRegistrationController</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pkg/controlplane/controller/crdregistration/crdregistration_controller.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCRDRegistrationController</span><span class="params">(crdinformer crdinformers.CustomResourceDefinitionInformer, apiServiceRegistration AutoAPIServiceRegistration)</span> *<span class="title">crdRegistrationController</span></span> &#123;</span><br><span class="line">	c := &amp;crdRegistrationController&#123;</span><br><span class="line">		crdLister:              crdinformer.Lister(),</span><br><span class="line">		crdSynced:              crdinformer.Informer().HasSynced,</span><br><span class="line">		apiServiceRegistration: apiServiceRegistration,</span><br><span class="line">		syncedInitialSet:       <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		queue:                  workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), <span class="string">&quot;crd_autoregistration_controller&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	c.syncHandler = c.handleVersionUpdate</span><br><span class="line">	crdinformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">		AddFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			cast := obj.(*apiextensionsv1.CustomResourceDefinition)</span><br><span class="line">			c.enqueueCRD(cast)</span><br><span class="line">		&#125;,</span><br><span class="line">		UpdateFunc: <span class="function"><span class="keyword">func</span><span class="params">(oldObj, newObj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			<span class="comment">// Enqueue both old and new object to make sure we remove and add appropriate API services.</span></span><br><span class="line">			<span class="comment">// The working queue will resolve any duplicates and only changes will stay in the queue.</span></span><br><span class="line">			c.enqueueCRD(oldObj.(*apiextensionsv1.CustomResourceDefinition))</span><br><span class="line">			c.enqueueCRD(newObj.(*apiextensionsv1.CustomResourceDefinition))</span><br><span class="line">		&#125;,</span><br><span class="line">		DeleteFunc: <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">			cast, ok := obj.(*apiextensionsv1.CustomResourceDefinition)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				tombstone, ok := obj.(cache.DeletedFinalStateUnknown)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;Couldn&#x27;t get object from tombstone %#v&quot;</span>, obj)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				cast, ok = tombstone.Obj.(*apiextensionsv1.CustomResourceDefinition)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;Tombstone contained unexpected object: %#v&quot;</span>, obj)</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			c.enqueueCRD(cast)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="准备启动"><a href="#准备启动" class="headerlink" title="准备启动"></a>准备启动</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *APIAggregator)</span> <span class="title">PrepareRun</span><span class="params">()</span> <span class="params">(preparedAPIAggregator, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// add post start hook before generic PrepareRun in order to be before /healthz installation</span></span><br><span class="line">	<span class="keyword">if</span> s.openAPIConfig != <span class="literal">nil</span> &#123;</span><br><span class="line">		s.GenericAPIServer.AddPostStartHookOrDie(<span class="string">&quot;apiservice-openapi-controller&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context genericapiserver.PostStartHookContext)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			<span class="keyword">go</span> s.openAPIAggregationController.Run(context.StopCh)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	prepared := s.GenericAPIServer.PrepareRun()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// delay OpenAPI setup until the delegate had a chance to setup their OpenAPI handlers</span></span><br><span class="line">	<span class="keyword">if</span> s.openAPIConfig != <span class="literal">nil</span> &#123;</span><br><span class="line">		specDownloader := openapiaggregator.NewDownloader()</span><br><span class="line">		openAPIAggregator, err := openapiaggregator.BuildAndRegisterAggregator(</span><br><span class="line">			&amp;specDownloader,</span><br><span class="line">			s.GenericAPIServer.NextDelegate(),</span><br><span class="line">			s.GenericAPIServer.Handler.GoRestfulContainer.RegisteredWebServices(),</span><br><span class="line">			s.openAPIConfig,</span><br><span class="line">			s.GenericAPIServer.Handler.NonGoRestfulMux)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> preparedAPIAggregator&#123;&#125;, err</span><br><span class="line">		&#125;</span><br><span class="line">		s.openAPIAggregationController = openapicontroller.NewAggregationController(&amp;specDownloader, openAPIAggregator)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 返回一个server和一个channel</span></span><br><span class="line">	<span class="keyword">return</span> preparedAPIAggregator&#123;APIAggregator: s, runnable: prepared&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//k8s.io/apiserver/pkg/server/genericapiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">PrepareRun</span><span class="params">()</span> <span class="title">preparedGenericAPIServer</span></span> &#123;</span><br><span class="line">	s.delegationTarget.PrepareRun()</span><br><span class="line">	<span class="comment">// 创建Swagger服务</span></span><br><span class="line">	<span class="keyword">if</span> s.openAPIConfig != <span class="literal">nil</span> &#123;</span><br><span class="line">		s.OpenAPIVersionedService, s.StaticOpenAPISpec = routes.OpenAPI&#123;</span><br><span class="line">			Config: s.openAPIConfig,</span><br><span class="line">		&#125;.Install(s.Handler.GoRestfulContainer, s.Handler.NonGoRestfulMux)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 调用InstallPathHandler注册&quot;/healthz&quot;和&quot;/livez&quot;健康检查，并绑定相应的handler</span></span><br><span class="line">	s.installHealthz()</span><br><span class="line">	s.installLivez()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加&quot;/readyz&quot;健康检查</span></span><br><span class="line">	err := s.addReadyzShutdownCheck(s.readinessStopCh)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">&quot;Failed to install readyz shutdown check %s&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	s.installReadyz()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register audit backend preShutdownHook.</span></span><br><span class="line">	<span class="keyword">if</span> s.AuditBackend != <span class="literal">nil</span> &#123;</span><br><span class="line">		err := s.AddPreShutdownHook(<span class="string">&quot;audit-backend&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			s.AuditBackend.Shutdown()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.Errorf(<span class="string">&quot;Failed to add pre-shutdown hook for audit-backend %s&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> preparedGenericAPIServer&#123;s&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>cobra执行启动server最后调用server.Run，最后会去执行<code>genericServer.Run</code>。这个server只在<code>stopCh</code>接收到信号时，才会退出。Run方法中调用了NonBlockingRun，创建一个https的server，对配置的addr(–insecure-bind-address和–insecure-port)绑定一个listener进行监听</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//k8s.io/apiserver/pkg/server/genericapiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedGenericAPIServer)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	delayedStopCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(delayedStopCh)</span><br><span class="line"></span><br><span class="line">		&lt;-stopCh</span><br><span class="line"></span><br><span class="line">		<span class="comment">// As soon as shutdown is initiated, /readyz should start returning failure.</span></span><br><span class="line">		<span class="comment">// This gives the load balancer a window defined by ShutdownDelayDuration to detect that /readyz is red</span></span><br><span class="line">		<span class="comment">// and stop sending traffic to this server.</span></span><br><span class="line">		<span class="built_in">close</span>(s.readinessStopCh)</span><br><span class="line"></span><br><span class="line">		time.Sleep(s.ShutdownDelayDuration)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// close socket after delayed stopCh</span></span><br><span class="line">	stoppedCh, err := s.NonBlockingRun(delayedStopCh)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&lt;-stopCh</span><br><span class="line"></span><br><span class="line">	<span class="comment">// run shutdown hooks directly. This includes deregistering from the kubernetes endpoint in case of kube-apiserver.</span></span><br><span class="line">	err = s.RunPreShutdownHooks()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wait for the delayed stopCh before closing the handler chain (it rejects everything after Wait has been called).</span></span><br><span class="line">	&lt;-delayedStopCh</span><br><span class="line">	<span class="comment">// wait for stoppedCh that is closed when the graceful termination (server.Shutdown) is finished.</span></span><br><span class="line">	&lt;-stoppedCh</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wait for all requests to finish, which are bounded by the RequestTimeout variable.</span></span><br><span class="line">	s.HandlerChainWaitGroup.Wait()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="s-NonBlockingRun"><a href="#s-NonBlockingRun" class="headerlink" title="s.NonBlockingRun"></a>s.NonBlockingRun</h3><p>NonBlockingRun主要执行步骤：</p>
<ol>
<li>创建并启动审计日志服务</li>
<li>创建并启动https server</li>
<li>遍历PostStartHooks，并为每个PostStartHook开一个goroutine执行PostStartHookFunc</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k8s.io/apiserver/pkg/server/genericapiserver.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedGenericAPIServer)</span> <span class="title">NonBlockingRun</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(&lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建审计的stop channel，用来在httpserver关闭后，不丢弃审计事件</span></span><br><span class="line">	auditStopCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 启动审计的channel</span></span><br><span class="line">	<span class="keyword">if</span> s.AuditBackend != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := s.AuditBackend.Run(auditStopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to run the audit backend: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建httpsServer</span></span><br><span class="line">	internalStopCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">var</span> stoppedCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">if</span> s.SecureServingInfo != <span class="literal">nil</span> &amp;&amp; s.Handler != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> err error</span><br><span class="line">		stoppedCh, err = s.SecureServingInfo.Serve(s.Handler, s.ShutdownTimeout, internalStopCh)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">close</span>(internalStopCh)</span><br><span class="line">			<span class="built_in">close</span>(auditStopCh)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Now that listener have bound successfully, it is the</span></span><br><span class="line">	<span class="comment">// responsibility of the caller to close the provided channel to</span></span><br><span class="line">	<span class="comment">// ensure cleanup.</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		&lt;-stopCh</span><br><span class="line">		<span class="built_in">close</span>(internalStopCh)</span><br><span class="line">		<span class="keyword">if</span> stoppedCh != <span class="literal">nil</span> &#123;</span><br><span class="line">			&lt;-stoppedCh</span><br><span class="line">		&#125;</span><br><span class="line">		s.HandlerChainWaitGroup.Wait()</span><br><span class="line">		<span class="built_in">close</span>(auditStopCh)</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="comment">// 执行postStartHooks</span></span><br><span class="line">	s.RunPostStartHooks(stopCh)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 发送ready信号</span></span><br><span class="line">	<span class="keyword">if</span> _, err := systemd.SdNotify(<span class="literal">true</span>, <span class="string">&quot;READY=1\n&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">&quot;Unable to send systemd daemon successful start message: %v\n&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> stoppedCh, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="大力运天地 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>大力运天地
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://owl0214.github.io/2021/08/30/Kubernetes/K8S/kube-apiserver%E9%83%BD%E5%81%9A%E4%BA%86%E4%BA%9B%E5%95%A5/" title="apiserver启动分析">https://owl0214.github.io/2021/08/30/Kubernetes/K8S/kube-apiserver都做了些啥/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"> k8s</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/08/27/Kubernetes/K8S/%E5%AE%B9%E5%99%A8%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5-%E6%8E%A2%E9%92%88%E6%9C%BA%E5%88%B6/" rel="prev" title="容器健康检查-探针机制">
                  <i class="fa fa-chevron-left"></i> 容器健康检查-探针机制
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">大力运天地</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#bfbfbf',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":true,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false,"scale":0.5},"react":{"opacity":0.7}});</script></body>
</html>
